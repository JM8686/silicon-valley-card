import React, { useState, useRef, useEffect, useMemo } from 'react';
import { Copy, Share2, Sparkles, User, RefreshCw, Briefcase, Zap, Download, Image as ImageIcon, Globe, Trophy, X, Link as LinkIcon } from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query } from 'firebase/firestore';

// -------------------------------------------------------------------------
// Firebase Initialization & Logic
// -------------------------------------------------------------------------
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

const GrandTitleGenerator = () => {
  const [inputText, setInputText] = useState('');
  const [loading, setLoading] = useState(false);
  const [capturing, setCapturing] = useState(false);
  const [result, setResult] = useState(null);
  const [toast, setToast] = useState({ show: false, message: '' });
  const [currentDomain, setCurrentDomain] = useState('');
  
  // Firebase Data State
  const [user, setUser] = useState(null);
  const [recentCards, setRecentCards] = useState([]);
  
  // Modal State for Viewing Others
  const [viewingCard, setViewingCard] = useState(null);

  // Refs
  const cardRef = useRef(null); // ìº¡ì²˜ìš©
  const topRef = useRef(null); // ìƒë‹¨ ì´ë™ìš© (ë©”ì¸ ì»¨í…Œì´ë„ˆ)
  const inputRef = useRef(null); // ì…ë ¥ì°½ í¬ì»¤ìŠ¤ìš©
  const vipScrollRef = useRef(null); // VIP ë¼ìš´ì§€ ìŠ¤í¬ë¡¤ìš©
  const animationRef = useRef(null); // ì• ë‹ˆë©”ì´ì…˜ í”„ë ˆì„ ID

  // Scroll State
  const [isPaused, setIsPaused] = useState(false);

  // API Key (Runtime Environment)
  const apiKey = ""; 

  // 1. Auth & Script Loading & SEO Injection
  useEffect(() => {
    // Set Current Domain for Watermark
    setCurrentDomain(window.location.host);

    // html2canvas load
    const script = document.createElement('script');
    script.src = "https://html2canvas.hertzen.com/dist/html2canvas.min.js";
    script.async = true;
    document.body.appendChild(script);

    // --- SEO Optimization ---
    const updateMeta = (name, content) => {
        let element = document.querySelector(`meta[name="${name}"]`);
        if (!element) {
            element = document.createElement('meta');
            element.name = name;
            document.head.appendChild(element);
        }
        element.content = content;
    };

    document.title = "ì‹¤ë¦¬ì½˜ë°¸ë¦¬ ëª…í•¨ ë§Œë“¤ê¸° - Grand Title Generator";
    updateMeta('description', 'í‰ë²”í•œ ì§ì—…ì„ ì‹¤ë¦¬ì½˜ë°¸ë¦¬ CEOì²˜ëŸ¼ í¬ì¥í•´ì£¼ëŠ” AI ëª…í•¨ ìƒì„±ê¸°ì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ì¼ìƒì„ ìœ„ëŒ€í•œ ê³¼ì—…ìœ¼ë¡œ ë°”ê¿”ë³´ì„¸ìš”.');
    updateMeta('keywords', 'ëª…í•¨ ë§Œë“¤ê¸°, ì‹¤ë¦¬ì½˜ë°¸ë¦¬, AI ì‘ëª…, í—ˆì„¸ ëª…í•¨, ì§ì—… í¬ì¥, ìœ ë¨¸, ìƒì„±í˜• AI');
    
    const updateOG = (property, content) => {
        let element = document.querySelector(`meta[property="${property}"]`);
        if (!element) {
            element = document.createElement('meta');
            element.setAttribute('property', property);
            document.head.appendChild(element);
        }
        element.content = content;
    };
    updateOG('og:title', 'ë‚´ ì§„ì§œ ì •ì²´ëŠ”? - ì‹¤ë¦¬ì½˜ë°¸ë¦¬ ëª…í•¨ ë§Œë“¤ê¸°');
    updateOG('og:description', 'ë‹¹ì‹ ì˜ í‰ë²”í•œ ì¼ìƒì„ ì‹¤ë¦¬ì½˜ë°¸ë¦¬ ìœ ë‹ˆì½˜ ê¸°ì—… CEOì²˜ëŸ¼ ë§Œë“¤ì–´ë“œë¦½ë‹ˆë‹¤.');
    updateOG('og:image', 'https://via.placeholder.com/1200x630.png?text=Silicon+Valley+Card');
    updateOG('og:type', 'website');

    // Auth Logic
    const initAuth = async () => {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        } catch (e) {
            console.error("Auth failed", e);
        }
    };
    initAuth();
    
    const unsubscribe = onAuthStateChanged(auth, setUser);

    return () => {
      if (document.body.contains(script)) {
        document.body.removeChild(script);
      }
      unsubscribe();
    };
  }, []);

  // 2. Fetch Recent Cards
  useEffect(() => {
    if (!user) return;

    const cardsRef = collection(db, 'artifacts', appId, 'public', 'data', 'cards');
    
    const unsubscribe = onSnapshot(cardsRef, (snapshot) => {
        const cards = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));
        
        cards.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
        setRecentCards(cards.slice(0, 20));
    }, (error) => {
        console.error("Error fetching cards:", error);
    });

    return () => unsubscribe();
  }, [user]);

  // 2.5 Prepare Display List (Ensure minimal length for scrolling)
  const displayList = useMemo(() => {
    if (recentCards.length === 0) return [];
    let cards = [...recentCards];
    // ë°ì´í„°ê°€ ì ì„ ê²½ìš° ê°•ì œë¡œ ëŠ˜ë ¤ì„œ ìŠ¤í¬ë¡¤ ì˜ì—­ í™•ë³´ (ìµœì†Œ 10ê°œ ê¸°ì¤€)
    while (cards.length < 10) {
        cards = [...cards, ...recentCards];
    }
    return cards;
  }, [recentCards]);

  // 3. VIP Lounge Auto Scroll Logic
  useEffect(() => {
    const scrollContainer = vipScrollRef.current;
    
    // displayListê°€ ë¹„ì–´ìˆìœ¼ë©´ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
    if (!scrollContainer || displayList.length === 0) return;

    const animate = () => {
      if (!isPaused && scrollContainer) {
        // ì†ë„ ì„¤ì • (1.0)
        const speed = 1.0;
        
        // ë¬´í•œ ìŠ¤í¬ë¡¤ ë¡œì§: ìŠ¤í¬ë¡¤ì´ ì ˆë°˜(ë³µì œëœ ë¶€ë¶„) ì´ìƒ ê°€ë©´ ì²˜ìŒìœ¼ë¡œ ë¦¬ì…‹
        if (scrollContainer.scrollLeft >= (scrollContainer.scrollWidth / 2)) {
           scrollContainer.scrollLeft = 0; 
        } else {
           scrollContainer.scrollLeft += speed;
        }
      }
      animationRef.current = requestAnimationFrame(animate);
    };

    // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ ë° ì¬ì‹œì‘
    if (animationRef.current) cancelAnimationFrame(animationRef.current);
    animationRef.current = requestAnimationFrame(animate);

    return () => {
        if (animationRef.current) cancelAnimationFrame(animationRef.current);
    };
  }, [isPaused, displayList]);


  // 4. Save Card Function
  const saveCardToFirestore = async (cardData) => {
      if (!user) return;
      try {
          const cardsRef = collection(db, 'artifacts', appId, 'public', 'data', 'cards');
          await addDoc(cardsRef, {
              ...cardData,
              userId: user.uid,
              createdAt: serverTimestamp()
          });
      } catch (e) {
          console.error("Error saving card:", e);
      }
  };

  // -------------------------------------------------------------------------
  // AI Logic
  // -------------------------------------------------------------------------
  const callGemini = async (prompt) => {
    try {
      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: { responseMimeType: "application/json" }
          }),
        }
      );
      if (!response.ok) throw new Error('API Call Failed');
      const data = await response.json();
      return JSON.parse(data.candidates[0].content.parts[0].text);
    } catch (error) {
      console.error("Gemini Error:", error);
      return null;
    }
  };

  const analyzeIdentity = async () => {
    if (!inputText.trim()) return;

    setLoading(true);
    setResult(null);

    const systemPrompt = `
      You are a satirical "Silicon Valley Business Card Generator" AI. 
      **GOAL:** Turn mundane inputs into **SHORT, WITTY, & PUNCHY** titles (English) and detailed, meme-heavy descriptions (Korean).
      **CRITICAL INSTRUCTIONS FOR TITLE (ENGLISH):**
      1. **Keep it Short & Punchy:** Max 3-5 words.
      2. **Meme-Style Humor:** Use "Protector", "Guardian", "Master", "Ninja", "Wizard", "Hunter".
      **CRITICAL INSTRUCTIONS FOR DESCRIPTION (KOREAN):**
      1. **LENGTH:** 2-3 sentences (approx 200-250 chars).
      2. **MEME FACTOR:** Use complex jargon to describe simple things.
      3. **SENTENCE STYLE:** Start with "ì €ëŠ”", end with "í•˜ê³  ìˆìŠµë‹ˆë‹¤".
      **OUTPUT FORMAT:** { "title": "Short Title", "desc": "Korean Description" }
      **Input:** "${inputText}"
    `;

    let aiResult = await callGemini(systemPrompt);

    if (!aiResult) {
       // Fallback mock data
       aiResult = {
           title: "Chief Error Handler",
           desc: "ì €ëŠ” ì˜ˆìƒì¹˜ ëª»í•œ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ì™€ ì‹¸ìš°ë©°, ì‚¬ìš©ìë“¤ì—ê²Œ ì§€ì† ê°€ëŠ¥í•œ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ê¸° ìœ„í•´ ê³ êµ°ë¶„íˆ¬í•˜ëŠ” ë””ì§€í„¸ í™˜ê²½ ë¯¸í™”ì› ì—…ë¬´ë¥¼ ìˆ˜í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤."
       };
    }

    const finalResult = { ...aiResult, originalInput: inputText };
    setResult(finalResult);
    saveCardToFirestore(finalResult);
    setLoading(false);
  };

  // -------------------------------------------------------------------------
  // Actions
  // -------------------------------------------------------------------------
  const showToast = (message) => {
    setToast({ show: true, message });
    setTimeout(() => setToast({ show: false, message: '' }), 3000);
  };

  // Helper for Clipboard Copy with Fallback
  const copyToClipboard = (text, successMessage) => {
    // 1. Try Clipboard API
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text)
        .then(() => showToast(successMessage))
        .catch((err) => {
          console.warn("Clipboard API failed, using fallback:", err);
          fallbackCopyText(text, successMessage);
        });
    } else {
      // 2. Fallback
      fallbackCopyText(text, successMessage);
    }
  };

  const fallbackCopyText = (text, successMessage) => {
    try {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      
      // Avoid scrolling to bottom
      textArea.style.position = "fixed";
      textArea.style.left = "-9999px";
      textArea.style.top = "0";
      
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      const successful = document.execCommand('copy');
      document.body.removeChild(textArea);
      
      if (successful) {
        showToast(successMessage);
      } else {
        console.error("Fallback copy failed.");
        showToast("ë³µì‚¬ ê¸°ëŠ¥ì´ ì§€ì›ë˜ì§€ ì•ŠëŠ” í™˜ê²½ì…ë‹ˆë‹¤.");
      }
    } catch (err) {
      console.error("Fallback copy error:", err);
      showToast("ë³µì‚¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  };

  const handleCopyText = () => {
    if (!result) return;
    const text = `[${result.title}]\n\n"${result.desc}"\n\nORIGIN: ${result.originalInput}\n\n#ì‹¤ë¦¬ì½˜ë°¸ë¦¬ëª…í•¨`;
    copyToClipboard(text, "í…ìŠ¤íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“");
  };

  const handleCopyLink = () => {
    const currentUrl = window.location.href;
    copyToClipboard(currentUrl, "ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ì¹œêµ¬ë“¤ì—ê²Œ ê³µìœ í•´ë³´ì„¸ìš” ğŸ”—");
  };

  const handleShareImage = async () => {
    if (!result || !cardRef.current || !window.html2canvas) {
        showToast("ì´ë¯¸ì§€ ìƒì„± ë„êµ¬ê°€ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤.");
        return;
    }
    setCapturing(true);
    
    // ë Œë”ë§ ì•ˆì •í™” ëŒ€ê¸°
    await new Promise(r => setTimeout(r, 200));

    try {
      const canvas = await window.html2canvas(cardRef.current, {
        backgroundColor: '#1a202c', scale: 2, logging: false, useCORS: true, allowTaint: true,
        scrollY: -window.scrollY, windowWidth: document.documentElement.offsetWidth,
        onclone: (clonedDoc) => {
            const cardEl = clonedDoc.getElementById('card-container');
            const descEl = clonedDoc.getElementById('card-description');
            
            if (cardEl) { cardEl.style.height = 'auto'; cardEl.style.overflow = 'visible'; }
            if (descEl) { 
                descEl.style.fontStyle = 'normal'; descEl.style.wordBreak = 'break-word';
                descEl.style.whiteSpace = 'pre-wrap'; descEl.style.overflow = 'visible';
                descEl.style.paddingRight = '10px';
            }
            
            const badge = clonedDoc.getElementById('card-badge');
            const badgeText = clonedDoc.getElementById('card-badge-text');
            if (badge) {
                badge.style.display = 'inline-flex'; badge.style.alignItems = 'center'; badge.style.justifyContent = 'center';
            }
            if (badgeText) {
                badgeText.style.lineHeight = '1';
            }
        }
      });

      canvas.toBlob(async (blob) => {
        if (!blob) { 
            setCapturing(false); 
            showToast("ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            return; 
        }
        
        const file = new File([blob], 'silicon-valley-card.png', { type: 'image/png' });
        
        const shareData = {
            files: [file],
            title: 'ì‹¤ë¦¬ì½˜ë°¸ë¦¬ ëª…í•¨ ë§Œë“¤ê¸°',
            text: `ì‹¤ë¦¬ì½˜ë°¸ë¦¬ ëª…í•¨ ë§Œë“¤ê¸° ğŸ‘‡\n[${result.title}]`,
        };

        // ê³µìœ  ë¡œì§: ì§€ì› ì‹œ ê³µìœ  -> ì‹¤íŒ¨ ë˜ëŠ” ë¯¸ì§€ì› ì‹œ ë‹¤ìš´ë¡œë“œ
        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
            try { 
                await navigator.share(shareData); 
            } catch (e) {
                // ì‚¬ìš©ìê°€ ì·¨ì†Œí•œ ê²½ìš°ëŠ” ì œì™¸í•˜ê³  ë‹¤ìš´ë¡œë“œ ì‹œë„
                if (e.name !== 'AbortError') {
                    downloadImage(canvas);
                }
            }
        } else {
            // ê³µìœ  ë¯¸ì§€ì› í™˜ê²½ (PC, ì¼ë¶€ ì¸ì•± ë¸Œë¼ìš°ì €)
            downloadImage(canvas);
        }
        setCapturing(false);
      }, 'image/png');
    } catch (e) {
      console.error(e);
      setCapturing(false);
      showToast("ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  };

  const downloadImage = (canvas) => {
      try {
        const link = document.createElement('a');
        link.download = `silicon-valley-card-${Date.now()}.png`;
        link.href = canvas.toDataURL('image/png');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast("ì´ë¯¸ì§€ë¥¼ ì €ì¥í–ˆìŠµë‹ˆë‹¤! ğŸ’¾");
      } catch (e) {
        showToast("ì´ë¯¸ì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      }
  };

  const handleReset = () => { 
      setResult(null); 
      setInputText('');
      if (topRef.current) {
          topRef.current.scrollIntoView({ behavior: 'smooth' });
      }
      setTimeout(() => {
          if (inputRef.current) {
              inputRef.current.focus();
          }
      }, 100);
  };

  const handleCardClick = (card) => {
      setResult(card);
      if (topRef.current) {
          topRef.current.scrollIntoView({ behavior: 'smooth' });
      }
  };

  // -------------------------------------------------------------------------
  // Render
  // -------------------------------------------------------------------------
  return (
    <main 
      ref={topRef} 
      className="min-h-[100dvh] bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 flex flex-col items-center justify-start p-4 font-sans selection:bg-yellow-300 selection:text-black overflow-x-hidden"
    >
      
      {/* Header Section */}
      <header className="text-center mt-8 mb-8 w-full max-w-2xl animate-fade-in-down">
        <div className="inline-block bg-white border-4 border-black px-6 py-2 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] mb-4 transform -rotate-2">
          <div className="flex items-center gap-2">
            <Briefcase className="w-6 h-6 text-indigo-600" />
            <h1 className="text-2xl md:text-3xl font-black text-black tracking-tighter uppercase">
              ì‹¤ë¦¬ì½˜ë°¸ë¦¬ ëª…í•¨ ë§Œë“¤ê¸°
            </h1>
          </div>
        </div>
        <div className="bg-yellow-300 border-4 border-black p-4 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] rounded-lg">
          <p className="text-black font-bold text-sm md:text-base leading-relaxed break-keep">
            ì§ì—…, ì·¨ë¯¸, í™œë™ ë“± ë‹¹ì‹ ì˜ ëª¨ë“  ëª¨ìŠµì„ <br className="hidden md:block"/>
            <span className="text-indigo-600 font-black">ì‹¤ë¦¬ì½˜ë°¸ë¦¬ì˜ ì„±ê³µí•œ ë¶€ì</span> ëª…í•¨ìœ¼ë¡œ ë°”ê¿” ë“œë¦½ë‹ˆë‹¤. âœ¨
          </p>
        </div>
      </header>

      {/* Main Card Creation Area */}
      <section className="w-full max-w-lg bg-white border-4 border-black shadow-[12px_12px_0px_0px_rgba(0,0,0,0.2)] rounded-xl overflow-hidden transform transition-all duration-300 mb-12 relative z-10">
        
        {/* Input Form */}
        {!result && !loading && (
          <div className="p-8 space-y-6">
            <div className="space-y-3">
              <label 
                htmlFor="job-input"
                className="flex items-center gap-2 text-black font-extrabold text-lg uppercase tracking-tight"
              >
                <Zap className="w-5 h-5 text-yellow-500 fill-current" />
                Current Status (ì…ë ¥)
              </label>
              <input
                ref={inputRef}
                id="job-input"
                type="text"
                value={inputText}
                onChange={(e) => setInputText(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && analyzeIdentity()}
                placeholder="ì˜ˆ: í¸ì˜ì  ì•Œë°”, ëˆ„ì›Œìˆê¸°, í—¬ìŠ¤ì¥..."
                className="w-full bg-indigo-50 text-black border-4 border-black focus:border-indigo-500 rounded-lg px-4 py-5 outline-none transition-all placeholder-gray-500 font-bold shadow-[4px_4px_0px_0px_rgba(0,0,0,0.1)] focus:shadow-[4px_4px_0px_0px_rgba(79,70,229,1)] text-base md:text-lg"
              />
            </div>
            <button
              onClick={analyzeIdentity}
              disabled={!inputText.trim()}
              className={`w-full py-4 rounded-lg font-black text-xl border-4 border-black shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] transform transition-all flex items-center justify-center gap-2 active:translate-y-1 active:shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] min-h-[60px]
                ${inputText.trim() ? 'bg-gradient-to-r from-yellow-400 to-orange-400 text-black hover:brightness-110 cursor-pointer' : 'bg-gray-200 text-gray-500 cursor-not-allowed border-gray-400 shadow-none'}`}
            >
              <Sparkles className="w-6 h-6" />
              ì‹¤ë¦¬ì½˜ë°¸ë¦¬ ëª…í•¨ ë§Œë“¤ê¸°
            </button>
          </div>
        )}

        {/* Loading State */}
        {loading && (
          <div className="p-12 flex flex-col items-center justify-center space-y-6 text-center bg-indigo-50 min-h-[300px]">
            <div className="w-20 h-20 border-8 border-black border-t-yellow-400 rounded-full animate-spin"></div>
            <div>
              <p className="text-xl font-black text-black animate-pulse">ì‹¤ë¦¬ì½˜ë°¸ë¦¬ ì—°ë´‰ í˜‘ìƒ ì¤‘... ğŸ’°</p>
              <p className="text-sm font-bold text-indigo-600 mt-2">Calculating Valuation...</p>
            </div>
          </div>
        )}

        {/* Result Card Display */}
        {result && !loading && (
          <div className="animate-fade-in-up">
            <article ref={cardRef} id="card-container" className="bg-[#1a202c] p-1 relative border-b-8 border-yellow-400">
              <div className="absolute inset-0 opacity-10" style={{backgroundImage: 'radial-gradient(#ffffff 1px, transparent 1px)', backgroundSize: '20px 20px'}}></div>
              <div className="relative z-10 p-6 md:p-8 flex flex-col h-auto min-h-[320px] justify-between">
                <div className="flex justify-between items-start mb-6">
                  <div className="w-12 h-12 bg-yellow-400 border-2 border-white rounded-full flex items-center justify-center shadow-lg">
                    <User className="text-black w-6 h-6" />
                  </div>
                  <div className="flex flex-col items-end pt-1">
                    <div className="text-yellow-400 text-xl tracking-widest font-bold drop-shadow-sm leading-none">â˜…â˜…â˜…â˜…â˜…</div>
                  </div>
                </div>
                <div className="mb-6 flex-grow">
                  <h2 className="text-2xl md:text-3xl font-serif font-bold text-white leading-tight mb-3 drop-shadow-md break-words" style={{ wordBreak: 'keep-all', overflowWrap: 'break-word' }}>
                    {result.title}
                  </h2>
                  <div className="h-1 w-16 bg-yellow-400 mb-4"></div>
                  <p id="card-description" className="text-gray-300 text-sm md:text-base font-medium italic leading-relaxed pr-2" style={{ wordBreak: 'keep-all', overflowWrap: 'break-word', whiteSpace: 'pre-wrap' }}>
                    "{result.desc}"
                  </p>
                </div>
                <div className="border-t border-gray-700 pt-3 mt-4">
                    <div className="flex justify-between items-center mb-1">
                        <p className="text-[10px] font-mono text-gray-500"><span className="text-indigo-400">ORIGIN:</span> {result.originalInput}</p>
                    </div>
                    <div className="flex justify-between items-end text-[10px] md:text-xs text-gray-400 font-mono">
                        <div><p className="text-yellow-400 font-bold">SILICON VALLEY HQ</p><p>1 Infinite Loop, Metaverse</p></div>
                    </div>
                </div>
              </div>
            </article>

            {/* Action Buttons (Share & Link) */}
            <div className="bg-yellow-50 p-4 border-b-4 border-black grid grid-cols-2 gap-3">
               <button 
                onClick={handleShareImage} 
                disabled={capturing} 
                className="flex-1 py-4 bg-indigo-600 text-white rounded-lg font-black text-sm md:text-lg border-4 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:translate-y-[-2px] hover:shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] active:translate-y-[2px] active:shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] transition-all flex items-center justify-center gap-2 disabled:opacity-70 disabled:cursor-wait min-h-[60px]"
                aria-label="ëª…í•¨ ì´ë¯¸ì§€ë¡œ ê³µìœ í•˜ê¸°"
               >
                {capturing ? <span className="flex items-center gap-2">ğŸ“¸ ìƒì„± ì¤‘...</span> : <><ImageIcon className="w-5 h-5" /> ì´ë¯¸ì§€ ê³µìœ </>}
              </button>
              
              <button 
                onClick={handleCopyLink} 
                className="flex-1 py-4 bg-white text-black rounded-lg font-black text-sm md:text-lg border-4 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:translate-y-[-2px] hover:shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] active:translate-y-[2px] active:shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] transition-all flex items-center justify-center gap-2 min-h-[60px]"
                aria-label="ì‚¬ì´íŠ¸ ë§í¬ ë³µì‚¬í•˜ê¸°"
               >
                <LinkIcon className="w-5 h-5" /> ë§í¬ ë³µì‚¬
              </button>
            </div>

            <div className="bg-white p-4 grid grid-cols-2 gap-3">
              <button 
                onClick={handleCopyText} 
                className="flex items-center justify-center gap-2 bg-white border-4 border-black text-black font-bold py-3 rounded-lg hover:bg-gray-100 active:bg-gray-200 transition-colors min-h-[50px]"
                aria-label="ëª…í•¨ í…ìŠ¤íŠ¸ë§Œ ë³µì‚¬í•˜ê¸°"
              >
                <Copy className="w-4 h-4" /> í…ìŠ¤íŠ¸ë§Œ ë³µì‚¬
              </button>
              <button 
                onClick={handleReset} 
                className="flex items-center justify-center gap-2 bg-gray-200 border-4 border-gray-400 text-gray-600 font-bold py-3 rounded-lg hover:bg-gray-300 transition-colors min-h-[50px]"
                aria-label="ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°"
              >
                <RefreshCw className="w-4 h-4" /> ë‹¤ì‹œ í•˜ê¸°
              </button>
            </div>
          </div>
        )}
      </section>

      {/* VIP Lounge (Infinite Scroll) */}
      <section className="w-full max-w-[95vw] px-4 pb-20 overflow-hidden">
        <div className="flex items-center justify-center gap-2 mb-6">
            <div className="h-px bg-white/30 flex-grow max-w-[100px]"></div>
            <div className="flex items-center gap-2 text-white">
                <Trophy className="w-5 h-5 text-yellow-300" />
                <h3 className="font-black text-xl uppercase tracking-wider text-shadow">VIP Lounge</h3>
            </div>
            <div className="h-px bg-white/30 flex-grow max-w-[100px]"></div>
        </div>
        
        <div className="relative w-full fade-mask">
            {/* Scroll Container with JS Animation Ref */}
            <div 
                ref={vipScrollRef}
                className="flex gap-4 overflow-x-auto scrollbar-hide"
                style={{ 
                    width: '100%', 
                    cursor: 'grab', 
                    WebkitOverflowScrolling: 'touch', 
                    touchAction: 'pan-x' // Limits touch to horizontal pan
                }} 
                onMouseEnter={() => setIsPaused(true)}
                onMouseLeave={() => setIsPaused(false)}
                onTouchStart={() => setIsPaused(true)} 
                onTouchEnd={() => setIsPaused(false)} 
                onTouchCancel={() => setIsPaused(false)} 
            >
                {displayList.length === 0 ? (
                    <div className="w-full text-center text-white/50 py-10 font-bold animate-pulse">
                        ì²« ë²ˆì§¸ VIPë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤...
                    </div>
                ) : (
                    // Render Cards
                    displayList.map((card, index) => (
                        <div 
                            key={`${card.id}-${index}`} 
                            onClick={() => setViewingCard(card)} 
                            className="flex-shrink-0 w-64 bg-[#1a202c] border-4 border-black rounded-lg shadow-lg cursor-pointer hover:scale-105 hover:z-20 transition-transform duration-300 relative overflow-hidden group"
                            role="button"
                            aria-label={`${card.title} ëª…í•¨ ë³´ê¸°`}
                        >
                            <div className="absolute top-0 left-0 w-full h-1 bg-yellow-400"></div>
                            <div className="p-5 h-full flex flex-col justify-between">
                                <div>
                                    <div className="flex justify-between items-start mb-3">
                                        <div className="w-8 h-8 bg-yellow-400 rounded-full flex items-center justify-center border border-white">
                                            <User className="w-4 h-4 text-black" />
                                        </div>
                                        <span className="text-[10px] text-yellow-400 font-bold tracking-widest">VIP</span>
                                    </div>
                                    <h4 className="text-white font-serif font-bold text-lg leading-tight line-clamp-2 mb-2">
                                        {card.title}
                                    </h4>
                                    <p className="text-gray-400 text-xs line-clamp-2 italic">
                                        "{card.desc}"
                                    </p>
                                </div>
                                <div className="mt-4 pt-3 border-t border-gray-700 flex justify-between items-center">
                                    <span className="text-[10px] text-gray-500 font-mono truncate max-w-[120px]">ORIGIN: {card.originalInput}</span>
                                    <Globe className="w-3 h-3 text-gray-600 group-hover:text-yellow-400 transition-colors" />
                                </div>
                            </div>
                        </div>
                    ))
                )}
            </div>
        </div>
        
        <p className="text-center text-white/60 text-xs font-medium mt-6">
            * ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ê±°ë‚˜ í„°ì¹˜í•˜ë©´ ë©ˆì¶¥ë‹ˆë‹¤.
        </p>
      </section>

      {/* Modal Card Viewer */}
      {viewingCard && (
        <div 
            className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in-down"
            onClick={() => setViewingCard(null)}
            role="dialog"
            aria-modal="true"
        >
            {/* Modal Wrapper: Max height and Scroll for Mobile */}
            <div 
                className="relative w-full max-w-lg max-h-[90vh] overflow-y-auto scrollbar-hide rounded-sm" 
                onClick={e => e.stopPropagation()}
            >
                {/* Close Button: Positioned Sticky at top-right for easy access */}
                <div className="sticky top-0 right-0 flex justify-end pb-2 z-50">
                    <button 
                        onClick={() => setViewingCard(null)}
                        className="text-white bg-gray-800/80 hover:bg-gray-700 rounded-full p-2 shadow-lg backdrop-blur-sm transition-colors"
                        aria-label="ë‹«ê¸°"
                    >
                        <X className="w-6 h-6" />
                    </button>
                </div>

                <div className="bg-[#1a202c] p-1 relative border-b-8 border-yellow-400 shadow-2xl rounded-sm mb-8">
                    <div className="absolute inset-0 opacity-10" style={{backgroundImage: 'radial-gradient(#ffffff 1px, transparent 1px)', backgroundSize: '20px 20px'}}></div>
                    <div className="relative z-10 p-6 md:p-8 flex flex-col h-auto min-h-[320px] justify-between">
                        <div className="flex justify-between items-start mb-6">
                            <div className="w-12 h-12 bg-yellow-400 border-2 border-white rounded-full flex items-center justify-center shadow-lg">
                                <User className="text-black w-6 h-6" />
                            </div>
                            <div className="flex flex-col items-end pt-1">
                                <div className="text-yellow-400 text-xl tracking-widest font-bold drop-shadow-sm leading-none">â˜…â˜…â˜…â˜…â˜…</div>
                            </div>
                        </div>
                        <div className="mb-6 flex-grow">
                            <h2 className="text-2xl md:text-3xl font-serif font-bold text-white leading-tight mb-3 drop-shadow-md break-words" style={{ wordBreak: 'keep-all', overflowWrap: 'break-word' }}>
                                {viewingCard.title}
                            </h2>
                            <div className="h-1 w-16 bg-yellow-400 mb-4"></div>
                            <p className="text-gray-300 text-sm md:text-base font-medium italic leading-relaxed pr-2" style={{ wordBreak: 'keep-all', overflowWrap: 'break-word', whiteSpace: 'pre-wrap' }}>
                                "{viewingCard.desc}"
                            </p>
                        </div>
                        <div className="border-t border-gray-700 pt-3 mt-4">
                            <div className="flex justify-between items-center mb-1">
                                <p className="text-[10px] font-mono text-gray-500"><span className="text-indigo-400">ORIGIN:</span> {viewingCard.originalInput}</p>
                            </div>
                            <div className="flex justify-between items-end text-[10px] md:text-xs text-gray-400 font-mono">
                                <div><p className="text-yellow-400 font-bold">SILICON VALLEY HQ</p><p>1 Infinite Loop, Metaverse</p></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
      )}

      {/* Toast Notification */}
      <div className={`fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-black text-white px-6 py-4 rounded-lg shadow-[8px_8px_0px_0px_rgba(255,255,255,0.5)] flex items-center gap-3 transition-all duration-300 z-50 border-2 border-white ${toast.show ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-10 pointer-events-none'}`}>
        <div className="bg-yellow-400 rounded-full p-1 border border-white"><Sparkles className="w-4 h-4 text-black" /></div>
        <span className="font-bold text-sm">{toast.message}</span>
      </div>

      <style>{`
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-down { animation: fadeInDown 0.6s ease-out; }
        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out; }
        .text-shadow { text-shadow: 2px 2px 0px rgba(0,0,0,0.3); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Fade Mask using mask-image */
        .fade-mask {
            mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
        }
      `}</style>
    </main>
  );
};

export default GrandTitleGenerator;